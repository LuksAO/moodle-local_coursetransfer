{"version":3,"file":"origin_restore_step3.min.js","sources":["../src/origin_restore_step3.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n// Project implemented by the \"Recovery, Transformation and Resilience Plan.\n// Funded by the European Union - Next GenerationEU\".\n//\n// Produced by the UNIMOODLE University Group: Universities of\n// Valladolid, Complutense de Madrid, UPV/EHU, León, Salamanca,\n// Illes Balears, Valencia, Rey Juan Carlos, La Laguna, Zaragoza, Málaga,\n// Córdoba, Extremadura, Vigo, Las Palmas de Gran Canaria y Burgos.\n\n/**\n *\n * @module     local_coursetransfer/origin_restore_step3\n * @copyright  2023 Proyecto UNIMOODLE\n * @author     UNIMOODLE Group (Coordinator) <direccion.area.estrategia.digital@uva.es>\n * @author     3IPUNT <contacte@tresipunt.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\n/* eslint-disable no-unused-vars */\n/* eslint-disable no-console */\n\ndefine([\n        'jquery',\n        'core/str',\n        'core/ajax',\n        'core/templates',\n        'local_coursetransfer/JSONutil'\n    ], function($, Str, Ajax, Templates, JSONutil) {\n        \"use strict\";\n\n        let ACTIONS = {\n            COURSE_SELECT: '[data-action=\"select\"]',\n            COURSE: '[data-action=\"course\"]',\n            NEXT: '[data-action=\"next\"]',\n            TARGET: '[data-action=\"target\"]',\n            CHECK: '[data-action=\"check\"]',\n            CHECK_ACT: '[data-action=\"act-check\"]'\n        };\n\n        /**\n         * @param {String} region\n         *\n         * @constructor\n         */\n        function originRestoreStep3(region) {\n            this.node = $(region);\n            this.data = JSON.parse(sessionStorage.getItem('local_coursetransfer_restore_page'), JSONutil.reviver);\n            let newcourses = [];\n            this.data.courses.forEach(function(course) {\n                course.targetid = 0;\n                course.categorytarget = 0;\n                newcourses.push(course);\n            });\n            this.data.courses = newcourses;\n            sessionStorage.setItem('local_coursetransfer_restore_page', JSON.stringify(this.data, JSONutil.replacer));\n            this.data = JSON.parse(sessionStorage.getItem('local_coursetransfer_restore_page'), JSONutil.reviver);\n            console.log('Step 3 data: ', this.data);\n            if (this.data !== null) {\n                this.data.courses.forEach(function(course) {\n                    let courseid = parseInt(course.courseid);\n                    let targetid = parseInt(course.targetid);\n                    $(ACTIONS.COURSE_SELECT + '[data-courseid=\"' + courseid + '\"]').prop(\"checked\", true);\n                    let seltarget = '[data-action=\"target\"][data-courseid=\"' + courseid + '\"] option[value=\"' + targetid + '\"]';\n                    $(seltarget).prop('selected', true);\n                });\n                this.data.configuration.forEach(function(config) {\n                    $('#' + config.name).prop('checked', config.selected);\n                });\n            }\n            this.node.find(ACTIONS.NEXT).on('click', this.clickNext.bind(this));\n            this.node.find('#origin_schedule').on('click', this.clickSchedule.bind(this));\n        }\n\n        originRestoreStep3.prototype.clickNext = function(e) {\n            this.data = JSON.parse(sessionStorage.getItem('local_coursetransfer_restore_page'), JSONutil.reviver);\n            let checkboxes = $('.configuration-checkbox');\n            let configuration = [];\n            checkboxes.each(function() {\n                if ($(this).attr(\"id\") === 'origin_schedule_datetime') {\n                    let datetime = $(this).val();\n                    configuration.push({\"name\": $(this).attr(\"id\"), \"value\": datetime});\n                } else {\n                    configuration.push({\"name\": $(this).attr(\"id\"), \"selected\": $(this).prop('checked')});\n                }\n            });\n            this.data.configuration = configuration;\n            sessionStorage.setItem('local_coursetransfer_restore_page', JSON.stringify(this.data, JSONutil.replacer));\n            // Generate a form with selected courses so next step will return selected courses only.\n            let form = this.generateForm();\n            form.submit();\n        };\n\n        originRestoreStep3.prototype.generateForm = function() {\n            this.data = JSON.parse(sessionStorage.getItem('local_coursetransfer_restore_page'), JSONutil.reviver);\n            let currentUrl = $(location).attr('href');\n            let url = new URL(currentUrl);\n            url.searchParams.set('step', '4');\n            let coursesForm = document.createElement(\"form\");\n            coursesForm.action = url.href;\n            coursesForm.method = \"POST\";\n            let input = [];\n            this.data.courses.forEach(function(course, index) {\n                input[index] = document.createElement(\"INPUT\");\n                input[index].name = 'courseids[]';\n                input[index].value = course.courseid;\n                input[index].type = 'hidden';\n                coursesForm.appendChild(input[index]);\n            });\n            let input2 = [];\n            this.data.courses.forEach(function(course, index) {\n                input2[index] = document.createElement(\"INPUT\");\n                input2[index].name = 'targetids[]';\n                input2[index].value = course.targetid;\n                input2[index].type = 'hidden';\n                coursesForm.appendChild(input2[index]);\n            });\n            let input3 = [];\n            this.data.courses.forEach(function(course, index) {\n                input3[index] = document.createElement(\"INPUT\");\n                input3[index].name = 'categorytargets[]';\n                input3[index].value = course.categorytarget;\n                input3[index].type = 'hidden';\n                coursesForm.appendChild(input3[index]);\n            });\n\n            document.body.appendChild(coursesForm);\n            return coursesForm;\n        };\n\n        originRestoreStep3.prototype.clickSchedule = function(e) {\n            if (this.node.find('#origin_schedule').is(':checked')) {\n                this.node.find('#origin_schedule_datetime').attr('disabled', false);\n            } else {\n                this.node.find('#origin_schedule_datetime').attr('disabled', true);\n            }\n        };\n\n        originRestoreStep3.prototype.node = null;\n\n        return {\n            /**\n             * @param {String} region\n             * @return {originRestoreStep3}\n             */\n            initRestoreStep3: function(region) {\n                // eslint-disable-next-line babel/new-cap\n                return new originRestoreStep3(region);\n            }\n        };\n    });\n"],"names":["define","$","Str","Ajax","Templates","JSONutil","ACTIONS","originRestoreStep3","region","node","data","JSON","parse","sessionStorage","getItem","reviver","newcourses","courses","forEach","course","targetid","categorytarget","push","setItem","stringify","this","replacer","console","log","courseid","parseInt","prop","configuration","config","name","selected","find","on","clickNext","bind","clickSchedule","prototype","e","checkboxes","each","attr","datetime","val","generateForm","submit","currentUrl","location","url","URL","searchParams","set","coursesForm","document","createElement","action","href","method","input","index","value","type","appendChild","input2","input3","body","is","initRestoreStep3"],"mappings":"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"}