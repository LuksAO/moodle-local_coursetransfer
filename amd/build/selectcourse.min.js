/**
 *
 * @module     local_coursetransfer
 * @copyright  2023 Proyecto UNIMOODLE
 * @author     UNIMOODLE Group (Coordinator) <direccion.area.estrategia.digital@uva.es>
 * @author     3IPUNT <contacte@tresipunt.com>
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("local_coursetransfer/selectcourse",["jquery","core/str","core/ajax","core/templates","local_coursetransfer/JSONutil"],(function($,Str,Ajax,Templates,JSONutil){let REGIONS_CATFORNEW='[data-region="category-for-new"]',REGIONS_COURSEFOREXIST='[data-region="course-for-exist"]',REGIONS_CATTARGETNAME='[data-region="cattargetname"]',REGIONS_CHANGEBUTTON='[data-region="change-button"]',REGIONS_COURSES_EMPTY='[data-region="courses-empty"]',REGIONS_COURSES_CONTAINER='[data-region="courses-found-container"]',ACTIONS_NEWOREXIST='[data-action="new-or-exist"]',ACTIONS_TARGETCAT='[data-action="target-category"]',ACTIONS_SEARCHCOURSE='[data-acton="search-course"]',SERVICES_SEARCH_COURSE="local_coursetransfer_dest_search_course_name";function selectcourse(region,courseid){this.node=$(region),this.courseid=courseid,this.node.find(REGIONS_COURSEFOREXIST).hide(),this.node.find(REGIONS_COURSES_EMPTY).hide(),this.node.find(ACTIONS_NEWOREXIST).on("change",this.neworexist.bind(this)),this.node.find(ACTIONS_TARGETCAT).on("change",this.targetcat.bind(this)),this.node.find(ACTIONS_SEARCHCOURSE).on("keyup",this.search.bind(this)),this.data=JSON.parse(sessionStorage.getItem("local_coursetransfer_restore_page"),JSONutil.reviver)}return selectcourse.prototype.neworexist=function(){0===parseInt(this.node.find(ACTIONS_NEWOREXIST).val())?(this.node.find(REGIONS_CATFORNEW).show(),this.node.find(REGIONS_COURSEFOREXIST).hide(),this.node.find(REGIONS_CATTARGETNAME).show(),this.node.find(REGIONS_CHANGEBUTTON).find("#in-new-course").show(),this.node.find(REGIONS_CHANGEBUTTON).find("#course-selected").hide()):(this.node.find(REGIONS_CATFORNEW).hide(),this.node.find(REGIONS_COURSEFOREXIST).show(),this.node.find(REGIONS_CATTARGETNAME).hide(),this.node.find(REGIONS_CHANGEBUTTON).find("#in-new-course").hide(),this.node.find(REGIONS_CHANGEBUTTON).find("#course-selected").show())},selectcourse.prototype.targetcat=function(){this.data=JSON.parse(sessionStorage.getItem("local_coursetransfer_restore_page"),JSONutil.reviver);let name=this.node.find(ACTIONS_TARGETCAT).children("option:selected").text(),catid=this.node.find(ACTIONS_TARGETCAT).val();this.node.find(REGIONS_CATTARGETNAME).text(name),this.node.find(REGIONS_CHANGEBUTTON).data("categorytarget",catid);let that=this,newcourses=[];this.data.courses.forEach((function(course){parseInt(course.courseid)==that.courseid&&(course.categorytarget=catid,course.targetid=0),newcourses.push(course)})),this.data.courses=newcourses,sessionStorage.setItem("local_coursetransfer_restore_page",JSON.stringify(this.data,JSONutil.replacer))},selectcourse.prototype.selectcourse=function(e){this.data=JSON.parse(sessionStorage.getItem("local_coursetransfer_restore_page"),JSONutil.reviver);let courseid=$(e.currentTarget).data("courseid"),coursename=this.node.find(REGIONS_COURSES_CONTAINER).find('[data-region="course-item-'+courseid+'"]').find(".coursename").text();this.node.find(ACTIONS_SEARCHCOURSE).val(coursename),this.node.find(REGIONS_CHANGEBUTTON).find("#course-selected").text(coursename);let that=this,newcourses=[];this.data.courses.forEach((function(course){parseInt(course.courseid)==that.courseid&&(course.targetid=courseid,course.categorytarget=0),newcourses.push(course)})),this.data.courses=newcourses,sessionStorage.setItem("local_coursetransfer_restore_page",JSON.stringify(this.data,JSONutil.replacer))},selectcourse.prototype.search=function(){let that=this,text=this.node.find(ACTIONS_SEARCHCOURSE).val();if(text.length>2){const request={methodname:SERVICES_SEARCH_COURSE,args:{text:text}};Ajax.call([request])[0].done((function(response){response.success?0===response.data.length?that.node.find(REGIONS_COURSES_EMPTY).show():(that.node.find(REGIONS_COURSES_CONTAINER).empty(),response.data.forEach((function(valor,indice,array){let course='<div class="courses-item" data-region="course-item-'+valor.id+'"><span class="coursename">'+valor.fullname+" ("+valor.id+')</span><button data-courseid="'+valor.id+'" data-action="select-course-destination-'+valor.id+'" class="btn btn-primary btn-sm" type="submit"><i class="fa fa-check-square" aria-hidden="true"></i></button></div>';that.node.find(REGIONS_COURSES_EMPTY).hide(),that.node.find(REGIONS_COURSES_CONTAINER).append(course);let dataaction='[data-action="select-course-destination-'+valor.id+'"]';that.node.find(dataaction).on("click",that.selectcourse.bind(that))}))):console.log(response)})).fail((function(fail){console.log(fail)}))}},selectcourse.prototype.node=null,{initSelectcourse:function(region,courseid){return new selectcourse(region,courseid)}}}));

//# sourceMappingURL=selectcourse.min.js.map